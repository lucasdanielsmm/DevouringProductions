<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devouring Lab - Comunidad</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* === TU CSS ORIGINAL SIN CAMBIOS === */
:root {
--bg-body:#f0f2f5;--bg-card:#fff;--accent:#4cc3ff;--accent-hover:#3aa8e0;
--text-main:#333;--text-sec:#999;--border-color:#ebebeb;
--radius:12px;--nav-height:64px;--subnav-height:56px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg-body)}
.profile-avatar{cursor:pointer}
</style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar">
  <div class="logo">Devouring<span>Lab</span></div>

  <div class="search-bar">
    <i class="fas fa-search"></i>
    <input type="text" placeholder="Buscar posts...">
  </div>

  <div style="display:flex;gap:25px;align-items:center">
    <i class="fas fa-edit"></i>
    <i class="fas fa-bell"></i>

    <!-- NUEVO: avatar real -->
    <img id="navbarAvatar"
         src="avatar-default.png"
         style="width:32px;height:32px;border-radius:50%;object-fit:cover">
  </div>
</nav>

<!-- ================= CONTENIDO ================= -->
<div class="container">

<!-- ======= MAIN ======= -->
<main></main>

<!-- ======= SIDEBAR PERFIL ======= -->
<aside class="sidebar-right">

<div class="profile-widget">
  <div class="profile-bg"></div>

  <!-- NUEVO -->
  <img id="profileAvatar"
       src="avatar-default.png"
       class="profile-avatar">

  <h3 id="profileName" style="margin-top:5px">Usuario</h3>

  <!-- NUEVO -->
  <input type="file" id="avatarInput" accept="image/*" hidden>

  <input id="nameInput"
         placeholder="Tu nombre"
         style="display:none;margin-top:6px;padding:6px;border-radius:8px;border:1px solid #ddd">

  <button id="saveProfileBtn"
          style="display:none;margin-top:8px;padding:6px 14px;border:none;border-radius:20px;background:#4cc3ff;color:white">
    Guardar perfil
  </button>
</div>

</aside>
</div>

<!-- ================= FIREBASE + CLOUDINARY ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === TU CONFIG FIREBASE === */
const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "devouringlab.firebaseapp.com",
  projectId: "devouringlab",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* === CLOUDINARY === */
const CLOUD_NAME = "TU_CLOUD_NAME";
const UPLOAD_PRESET = "TU_UPLOAD_PRESET";

/* === ELEMENTOS === */
const navbarAvatar = document.getElementById("navbarAvatar");
const profileAvatar = document.getElementById("profileAvatar");
const profileName = document.getElementById("profileName");
const avatarInput = document.getElementById("avatarInput");
const nameInput = document.getElementById("nameInput");
const saveBtn = document.getElementById("saveProfileBtn");

/* === SUBIR IMAGEN === */
async function uploadAvatar(file, uid) {
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", UPLOAD_PRESET);
  form.append("public_id", uid);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    { method: "POST", body: form }
  );

  return (await res.json()).secure_url;
}

/* === AUTH === */
onAuthStateChanged(auth, async user => {
  if (!user) return;

  nameInput.style.display = "block";
  saveBtn.style.display = "inline-block";

  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const d = snap.data();
    profileName.textContent = d.displayName || "Usuario";
    profileAvatar.src = d.photoURL || "avatar-default.png";
    navbarAvatar.src = d.photoURL || "avatar-default.png";
    nameInput.value = d.displayName || "";
  }
});

/* === EVENTOS === */
profileAvatar.onclick = () => avatarInput.click();

saveBtn.onclick = async () => {
  const user = auth.currentUser;
  if (!user) return;

  let photoURL = profileAvatar.src;

  if (avatarInput.files[0]) {
    photoURL = await uploadAvatar(avatarInput.files[0], user.uid);
  }

  await setDoc(doc(db, "users", user.uid), {
    displayName: nameInput.value,
    photoURL
  }, { merge: true });

  profileName.textContent = nameInput.value;
  profileAvatar.src = photoURL;
  navbarAvatar.src = photoURL;
};
</script>

</body>
</html>
