<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devouring Lab - Comunidad</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar">
  <div class="logo">Devouring<span>Lab</span></div>
  <div class="search-bar">
    <i class="fas fa-search"></i>
    <input type="text" placeholder="Buscar posts...">
  </div>
  <div id="authArea">
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>
</nav>

<!-- ================= MAIN ================= -->
<main style="max-width:800px;margin:40px auto">

<!-- PERFIL -->
<section id="profile" style="display:none">
  <h3>Mi perfil</h3>
  <input type="text" id="displayName" placeholder="Nombre">
  <input type="file" id="photoInput" accept="image/*">
  <img id="profilePhoto" width="80">
  <button id="saveProfile">Guardar perfil</button>
</section>

<hr>

<!-- CREAR POST -->
<section id="createPost" style="display:none">
  <h3>Nuevo post</h3>
  <input id="postTitle" placeholder="Título"><br><br>
  <textarea id="postText" placeholder="Contenido"></textarea><br><br>
  <select id="postGame">
    <option value="general">General</option>
    <option value="vireo">Vireo</option>
    <option value="cae">Cae</option>
  </select><br><br>
  <input type="file" id="postImage" accept="image/*"><br><br>
  <button id="publishPost">Publicar</button>
</section>

<hr>

<!-- FEED -->
<section id="feed"></section>

</main>

<!-- ================= FIREBASE + CLOUDINARY ================= -->
<script type="module">
/* ================= CLOUDINARY ================= */
const CLOUD_NAME = "dyhvx2vsz";
const UPLOAD_PRESET = "DevouringIMG";

/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, setDoc, getDoc,
  collection, addDoc, getDocs,
  serverTimestamp, query, orderBy 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_vxI4azIIPRyXE3LCAlYDS1xKnwMSYmk",
  authDomain: "devouringlab.firebaseapp.com",
  projectId: "devouringlab"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= CLOUDINARY UPLOAD ================= */
async function uploadToCloudinary(file) {
  const form = new FormData();
  form.append("file", file);
  form.append("upload_preset", UPLOAD_PRESET);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    { method: "POST", body: form }
  );

  const data = await res.json();
  return data.secure_url;
}

/* ================= AUTH ================= */
loginBtn.onclick = async () => {
  const email = prompt("Email");
  const pass = prompt("Contraseña");
  await signInWithEmailAndPassword(auth, email, pass);
};

registerBtn.onclick = async () => {
  const email = prompt("Email");
  const pass = prompt("Contraseña");
  await createUserWithEmailAndPassword(auth, email, pass);
};

/* ================= SESSION ================= */
onAuthStateChanged(auth, async user => {
  if (!user) return;

  profile.style.display = "block";
  createPost.style.display = "block";

  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    await setDoc(ref, {
      displayName: user.email.split("@")[0],
      photoURL: "",
      createdAt: serverTimestamp()
    });
  }

  const data = (await getDoc(ref)).data();
  displayName.value = data.displayName;
  profilePhoto.src = data.photoURL || "";
  loadPosts();
});

/* ================= SAVE PROFILE ================= */
saveProfile.onclick = async () => {
  const user = auth.currentUser;
  if (!user) return;

  let photoURL = profilePhoto.src;
  if (photoInput.files[0]) {
    photoURL = await uploadToCloudinary(photoInput.files[0]);
    profilePhoto.src = photoURL;
  }

  await setDoc(doc(db, "users", user.uid), {
    displayName: displayName.value,
    photoURL
  }, { merge: true });

  alert("Perfil actualizado");
};

/* ================= CREATE POST ================= */
publishPost.onclick = async () => {
  const user = auth.currentUser;
  if (!user) return;

  const userData = (await getDoc(doc(db, "users", user.uid))).data();
  let imageURL = "";

  if (postImage.files[0]) {
    imageURL = await uploadToCloudinary(postImage.files[0]);
  }

  await addDoc(collection(db, "posts"), {
    uid: user.uid,
    authorName: userData.displayName,
    authorPhoto: userData.photoURL,
    title: postTitle.value,
    text: postText.value,
    game: postGame.value,
    imageURL,
    createdAt: serverTimestamp()
  });

  postTitle.value = "";
  postText.value = "";
  postImage.value = "";
  loadPosts();
};

/* ================= LOAD FEED ================= */
async function loadPosts() {
  feed.innerHTML = "";
  const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
  const snap = await getDocs(q);

  snap.forEach(docu => {
    const p = docu.data();
    feed.innerHTML += `
      <article style="border:1px solid #ddd;padding:15px;margin-bottom:10px">
        <img src="${p.authorPhoto}" width="32">
        <b>${p.authorName}</b>
        <h4>${p.title}</h4>
        <p>${p.text}</p>
        ${p.imageURL ? `<img src="${p.imageURL}" width="100%">` : ""}
      </article>
    `;
  });
}
</script>

</body>
</html>
