<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devouring Lab - Comunidad</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* =====================
   ESTILOS (SIN CAMBIOS VISUALES IMPORTANTES)
   ===================== */
:root {
    --bg-body:#f0f2f5;
    --bg-card:#ffffff;
    --accent:#4cc3ff;
    --text-main:#333;
    --text-sec:#999;
    --border-color:#ebebeb;
    --radius:12px;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
    font-family:'Segoe UI',Arial,sans-serif;
    background:var(--bg-body);
    color:var(--text-main);
}

.navbar{
    height:64px;
    background:#fff;
    border-bottom:1px solid var(--border-color);
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0 25px;
    position:sticky;
    top:0;
    z-index:1000;
}

.logo{font-weight:800;font-size:22px}
.logo span{color:var(--accent)}

.search-bar{
    background:#f4f4f4;
    padding:8px 14px;
    border-radius:20px;
    width:320px;
    display:flex;
    align-items:center;
}
.search-bar input{
    border:none;
    background:transparent;
    outline:none;
    margin-left:8px;
    width:100%;
}

.nav-actions{
    display:flex;
    gap:20px;
    align-items:center;
}

.nav-icon-btn{cursor:pointer}

.game-nav{
    position:sticky;
    top:64px;
    background:#fff;
    display:flex;
    justify-content:center;
    gap:12px;
    padding:10px;
    border-bottom:1px solid var(--border-color);
}

.game-item{
    padding:6px 14px;
    border-radius:20px;
    cursor:pointer;
    font-size:13px;
    border:1px solid transparent;
}
.game-item.active{
    background:var(--accent);
    color:white;
}

.container{
    max-width:1300px;
    margin:25px auto;
    display:grid;
    grid-template-columns:260px 1fr 320px;
    gap:25px;
}

.post-card{
    background:#fff;
    border:1px solid var(--border-color);
    border-radius:12px;
    padding:18px;
    margin-bottom:15px;
}

.hashtag-link{
    color:var(--accent);
    font-weight:600;
    cursor:pointer;
    text-decoration:none;
}

.interaction-btn{
    cursor:pointer;
    display:flex;
    gap:6px;
    align-items:center;
}

.interaction-btn.liked{
    color:#ff4c4c;
}

.modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:3000;
}

.modal-card{
    background:#fff;
    border-radius:14px;
    padding:25px;
    width:520px;
}
</style>
</head>

<body>

<nav class="navbar">
    <div class="logo">Devouring<span>Lab</span></div>

    <div class="search-bar">
        <i class="fas fa-search"></i>
        <input id="searchInput" placeholder="Buscar por hashtag">
    </div>

    <div class="nav-actions">
        <i class="fas fa-edit nav-icon-btn" id="openPublishBtn"></i>
        <img id="navAvatar" src="https://via.placeholder.com/36" style="border-radius:50%;cursor:pointer">
    </div>
</nav>

<div class="game-nav">
    <div class="game-item active" data-game="all">General</div>
    <div class="game-item" data-game="vireo">Vireo</div>
    <div class="game-item" data-game="cae">Cae</div>
    <div class="game-item" data-game="lanzer">Lanzer</div>
    <div class="game-item" data-game="dinoma">Dinoma</div>
</div>

<div class="container">
    <aside></aside>

    <main>
        <div id="postsContainer" style="text-align:center;color:#999">
            Cargando publicaciones...
        </div>
    </main>

    <aside></aside>
</div>

<div class="modal-overlay" id="publishModal">
    <div class="modal-card">
        <h3>Crear publicación</h3>
        <textarea id="postContent" style="width:100%;height:120px;margin-top:10px"></textarea>
        <button id="submitPostBtn" style="margin-top:10px">Publicar</button>
    </div>
</div>

<script type="module">
/* =====================
   FIREBASE
   ===================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC_vxI4azIIPRyXE3LCAlYDS1xKnwMSYmk",
    authDomain: "devouringlab.firebaseapp.com",
    projectId: "devouringlab",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let unsubscribeFeed = null;

/* =====================
   UTILIDADES SEGURAS
   ===================== */
const escapeHtml = (t="") =>
    t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

const parseText = (t) =>
    escapeHtml(t).replace(/#(\w+)/g,
        '<span class="hashtag-link" onclick="searchTag(\'$1\')">#$1</span>'
    );

/* =====================
   FEED
   ===================== */
window.loadFeed = (game="all") => {
    if(unsubscribeFeed) unsubscribeFeed();

    document.getElementById("postsContainer").innerHTML="Cargando...";

    const q = query(collection(db,"posts"), orderBy("timestamp","desc"));

    unsubscribeFeed = onSnapshot(q,snap=>{
        let html="";
        snap.forEach(d=>{
            const p=d.data();
            if(game!=="all" && p.game!==game) return;

            const liked = currentUser && (p.likes||[]).includes(currentUser.uid);

            html+=`
            <div class="post-card">
                <div>${parseText(p.content||"")}</div>
                <div style="margin-top:10px;display:flex;gap:15px">
                    <div class="interaction-btn ${liked?"liked":""}"
                         onclick="toggleLike('${d.id}',${liked})">
                        <i class="fa${liked?"s":"r"} fa-heart"></i>
                        ${(p.likes||[]).length}
                    </div>
                </div>
            </div>`;
        });

        document.getElementById("postsContainer").innerHTML =
            html || "<div style='color:#999'>No hay publicaciones</div>";
    });
};

/* =====================
   INTERACCIONES
   ===================== */
window.toggleLike = async (id,liked)=>{
    if(!currentUser) return alert("Inicia sesión");
    const ref = doc(db,"posts",id);
    await updateDoc(ref,{
        likes: liked ? arrayRemove(currentUser.uid)
                     : arrayUnion(currentUser.uid)
    });
};

window.searchTag = (tag)=>{
    document.getElementById("searchInput").value="#"+tag;
    loadFeed("all");
};

/* =====================
   EVENTOS
   ===================== */
document.querySelectorAll(".game-item").forEach(el=>{
    el.onclick=()=>{
        document.querySelectorAll(".game-item").forEach(x=>x.classList.remove("active"));
        el.classList.add("active");
        loadFeed(el.dataset.game);
    };
});

document.getElementById("openPublishBtn").onclick=()=>{
    if(!currentUser) return signInWithPopup(auth,provider);
    document.getElementById("publishModal").style.display="flex";
};

document.getElementById("submitPostBtn").onclick=async()=>{
    const content=document.getElementById("postContent").value.trim();
    if(!content) return;

    await addDoc(collection(db,"posts"),{
        content,
        game:"all",
        likes:[],
        timestamp:serverTimestamp()
    });

    document.getElementById("postContent").value="";
    document.getElementById("publishModal").style.display="none";
};

/* =====================
   AUTH
   ===================== */
onAuthStateChanged(auth,u=>{
    currentUser=u;
    loadFeed("all");
});
</script>

</body>
</html>
