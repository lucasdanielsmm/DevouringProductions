<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devouring Lab - Comunidad</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- TODO TU CSS ORIGINAL SIN CAMBIOS -->
    <style>
        /* === CSS ORIGINAL √çNTEGRO === */
        /* (no lo repito aqu√≠ para no ensuciar: ES EXACTAMENTE EL TUYO) */
    </style>
</head>

<body>
<!-- TODO TU HTML ORIGINAL SIN CAMBIOS -->
<!-- navbar, game-nav, container, modales, etc. -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot,
  serverTimestamp, doc, setDoc, getDoc, updateDoc,
  arrayUnion, arrayRemove, getDocs, limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyC_vxI4azIIPRyXE3LCAlYDS1xKnwMSYmk",
  authDomain: "devouringlab.firebaseapp.com",
  projectId: "devouringlab",
  storageBucket: "devouringlab.firebasestorage.app",
  messagingSenderId: "383272939740",
  appId: "1:383272939740:web:203f83c89b1c7bd6344419"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const ADMIN_UIDS = ["qlJIBLf1I1clEVk2uggolNWL4Ai1"];

/* ================= ESTADO GLOBAL ================= */
let currentUser = null;
let currentUserData = null;
let uploadedImageUrl = "";
let unsubscribeFeed = null; // üî• CLAVE

/* ================= SEGURIDAD TEXTO ================= */
const escapeHTML = (str = "") =>
  str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

const parseText = (text="") => {
  let safe = escapeHTML(text);
  safe = safe.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" class="hashtag-link">$1</a>');
  safe = safe.replace(/#(\w+)/g,'<span class="hashtag-link" onclick="searchTag(\'$1\')">#$1</span>');
  return safe;
};

/* ================= AUTH ================= */
onAuthStateChanged(auth, async (user) => {
  currentUser = user;

  if (user) {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      await setDoc(ref, {
        uid: user.uid,
        displayName: user.displayName,
        photoURL: user.photoURL,
        createdAt: serverTimestamp(),
        followers: [],
        following: [],
        postCount: 0,
        isAdmin: ADMIN_UIDS.includes(user.uid)
      });
      currentUserData = { following: [], postCount: 0 };
    } else {
      currentUserData = snap.data();
    }
  } else {
    currentUserData = null;
  }

  loadFeed("all");
});

/* ================= FEED (CORREGIDO) ================= */
window.loadFeed = (type="all", value=null) => {
  const feedDiv = document.getElementById("postsContainer");
  if (!feedDiv) return;

  feedDiv.innerHTML = "<p style='text-align:center;padding:20px;color:#999'>Cargando...</p>";

  if (unsubscribeFeed) {
    unsubscribeFeed();
    unsubscribeFeed = null;
  }

  const q = query(collection(db,"posts"), orderBy("timestamp","desc"), limit(50));

  unsubscribeFeed = onSnapshot(q, (snapshot) => {
    feedDiv.innerHTML = "";
    let posts = [];
    snapshot.forEach(d => posts.push({ id:d.id, ...d.data() }));

    if (type === "following" && currentUserData)
      posts = posts.filter(p => currentUserData.following.includes(p.authorUid));

    if (type === "game")
      posts = posts.filter(p => p.game === value);

    if (type === "section")
      posts = posts.filter(p => p.section === value);

    if (type === "tag")
      posts = posts.filter(p => (p.tags||[]).includes(value));

    if (!posts.length) {
      feedDiv.innerHTML = "<div style='text-align:center;padding:30px;color:#999'>No hay publicaciones</div>";
      return;
    }

    posts.forEach(p => {
      const liked = currentUser && (p.likes||[]).includes(currentUser.uid);
      feedDiv.innerHTML += `
        <article class="post-card">
          <div class="user-header">
            <div class="avatar-ring ${p.isOfficial?'official':''}">
              <img src="${p.authorAvatar}">
            </div>
            <b>${p.authorName}</b>
          </div>
          <div class="post-text">${parseText(p.content)}</div>
          ${p.image ? `<img src="${p.image}" style="width:100%;border-radius:8px">` : ""}
          <div class="interaction-btn ${liked?'liked':''}" onclick="toggleLike('${p.id}',${liked})">
            <i class="${liked?'fas':'far'} fa-heart"></i> ${(p.likes||[]).length}
          </div>
        </article>`;
    });
  });
};

/* ================= INTERACCIONES ================= */
window.toggleLike = async (id, liked) => {
  if (!currentUser) return alert("Inicia sesi√≥n");
  const ref = doc(db,"posts",id);
  await updateDoc(ref,{
    likes: liked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid)
  });
};

window.searchTag = (t) => loadFeed("tag", t);
window.filterGame = (g) => loadFeed("game", g);
window.doLogout = () => signOut(auth);

</script>
</body>
</html>
