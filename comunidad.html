<!-- ðŸ”¥ VERSIÃ“N CORREGIDA Y ESTABLE ðŸ”¥ -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devouring Lab - Comunidad</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* === ESTILOS SIN CAMBIOS FUNCIONALES === */
:root {
    --bg-body:#f0f2f5;
    --bg-card:#ffffff;
    --accent:#4cc3ff;
    --accent-hover:#3aa8e0;
    --text-main:#333;
    --text-sec:#999;
    --border-color:#ebebeb;
    --radius:12px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
    font-family:'Segoe UI',Arial,sans-serif;
    background:var(--bg-body);
    color:var(--text-main);
}
.hashtag-link{color:var(--accent);cursor:pointer;font-weight:600}
.hashtag-link:hover{text-decoration:underline}
.interaction-btn{cursor:pointer;display:flex;gap:6px;align-items:center}
.interaction-btn.liked{color:#ff4c4c}
</style>
</head>

<body>

<!-- ================== UI (SIN CAMBIOS) ================== -->
<!-- (Navbar, sidebar, modales, etc. â†’ exactamente igual que tu HTML original) -->
<!-- â›” OMITIDO AQUÃ PARA NO REPETIR VISUAL â›” -->

<!-- ================== SCRIPT ================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================== CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyC_vxI4azIIPRyXE3LCAlYDS1xKnwMSYmk",
  authDomain: "devouringlab.firebaseapp.com",
  projectId: "devouringlab",
  storageBucket: "devouringlab.firebasestorage.app",
  messagingSenderId: "383272939740",
  appId: "1:383272939740:web:203f83c89b1c7bd6344419"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let currentUserData = null;
let unsubscribeFeed = null;

/* ================== UTILIDADES SEGURAS ================== */
const escapeHTML = (str="") =>
  str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

const parseText = (text="") => {
  let safe = escapeHTML(text);
  safe = safe.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" class="hashtag-link">$1</a>');
  safe = safe.replace(/#(\w+)/g,'<span class="hashtag-link" onclick="searchTag(\'$1\')">#$1</span>');
  return safe;
};

/* ================== AUTH ================== */
onAuthStateChanged(auth, async (user)=>{
  currentUser = user;
  if(user){
    const ref = doc(db,"users",user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{
        uid:user.uid,
        displayName:user.displayName,
        photoURL:user.photoURL,
        createdAt:serverTimestamp(),
        followers:[],
        following:[],
        postCount:0
      });
      currentUserData={following:[],postCount:0};
    } else {
      currentUserData=snap.data();
    }
  } else {
    currentUserData=null;
  }
  loadFeed("all");
});

/* ================== FEED CENTRAL ================== */
window.loadFeed = (type="all", value=null)=>{
  if(unsubscribeFeed) unsubscribeFeed();

  const feed=document.getElementById("postsContainer");
  feed.innerHTML="Cargando...";

  const q=query(collection(db,"posts"),orderBy("timestamp","desc"),limit(50));

  unsubscribeFeed=onSnapshot(q,(snap)=>{
    let posts=[];
    snap.forEach(d=>posts.push({id:d.id,...d.data()}));

    if(type==="game") posts=posts.filter(p=>p.game===value);
    if(type==="tag") posts=posts.filter(p=>p.tags?.includes(value));
    if(type==="following" && currentUserData)
      posts=posts.filter(p=>currentUserData.following.includes(p.authorUid));

    feed.innerHTML="";
    if(!posts.length){
      feed.innerHTML="<div style='padding:30px;color:#999;text-align:center'>No hay publicaciones</div>";
      return;
    }

    posts.forEach(p=>{
      const liked=currentUser && p.likes?.includes(currentUser.uid);
      feed.innerHTML+=`
      <div class="post-card">
        <b>${p.authorName}</b>
        <div class="post-text">${parseText(p.content)}</div>
        ${p.image?`<img src="${p.image}" style="width:100%;border-radius:8px">`:""}
        <div class="interaction-btn ${liked?"liked":""}" onclick="toggleLike('${p.id}',${liked})">
          <i class="${liked?"fas":"far"} fa-heart"></i> ${(p.likes||[]).length}
        </div>
      </div>`;
    });
  });
};

/* ================== INTERACCIONES ================== */
window.toggleLike = async(id,liked)=>{
  if(!currentUser) return alert("Inicia sesiÃ³n");
  const ref=doc(db,"posts",id);
  await updateDoc(ref,{
    likes: liked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid)
  });
};

window.searchTag = (t)=>loadFeed("tag",t);

/* ================== FOLLOW SIN RELOAD ================== */
window.followUser = async(uid)=>{
  if(!currentUser) return alert("Inicia sesiÃ³n");
  const ref=doc(db,"users",currentUser.uid);
  const following=currentUserData.following||[];
  const update=following.includes(uid)
    ? arrayRemove(uid)
    : arrayUnion(uid);
  await updateDoc(ref,{following:update});
  currentUserData.following =
    following.includes(uid)
      ? following.filter(x=>x!==uid)
      : [...following,uid];
};

/* ================== LOGIN ================== */
window.doLogout=()=>signOut(auth);
</script>

</body>
</html>
