<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devouring Lab - Comunidad</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --accent: #4cc3ff; 
            --accent-hover: #3aa8e0;
            --text-main: #333333;
            --text-sec: #999999;
            --border-color: #ebebeb;
            --radius: 12px;
            --nav-height: 64px;
            --subnav-height: 56px;
            --overlay-color: rgba(0, 0, 0, 0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-y: scroll;
        }

        /* --- NAVBAR --- */
        .navbar {
            background: var(--bg-card);
            height: var(--nav-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: sticky; top: 0; z-index: 2000;
            border-bottom: 1px solid var(--border-color);
        }

        .logo { font-weight: 800; font-size: 22px; color: var(--text-main); letter-spacing: -0.5px; }
        .logo span { color: var(--accent); }

        .search-bar {
            background: #f4f4f4; border-radius: 20px; padding: 8px 15px; width: 300px;
            display: flex; align-items: center; color: var(--text-sec);
        }
        .search-bar input { border: none; background: transparent; outline: none; margin-left: 10px; width: 100%; }

        .nav-actions { display: flex; gap: 25px; align-items: center; color: #666; }
        .nav-icon-btn { cursor: pointer; transition: color 0.2s; font-size: 18px; }
        .nav-icon-btn:hover { color: var(--accent); }

        /* --- MENÚ USUARIO --- */
        .user-menu-wrapper { position: relative; padding: 10px 0; }
        .user-avatar-nav {
            width: 32px; height: 32px; background: #ddd; border-radius: 50%; cursor: pointer;
            object-fit: cover;
        }
        
        .user-dropdown-card {
            display: none; position: absolute; top: 100%; right: 0; width: 260px;
            background: var(--bg-card); border-radius: var(--radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 20px; z-index: 2100;
            text-align: center; border: 1px solid var(--border-color);
        }
        .user-menu-wrapper:hover .user-dropdown-card { display: block; animation: fadeIn 0.2s; }

        .auth-btn {
            display: block; width: 100%; padding: 10px; margin-top: 10px;
            border-radius: 20px; border: none; cursor: pointer; font-weight: 600; font-size: 14px;
        }
        .btn-login { background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .btn-register { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn-login:hover { background: var(--accent-hover); }

        /* --- JUEGOS NAV --- */
        .game-nav {
            position: sticky; top: var(--nav-height); z-index: 1900; height: var(--subnav-height);
            background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        .game-item {
            display: flex; align-items: center; gap: 10px; padding: 6px 14px;
            border-radius: 25px; cursor: pointer; transition: 0.2s;
            font-size: 13px; font-weight: 600; color: #555; border: 1px solid transparent;
        }
        .game-item img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #eee; }
        .game-item:hover { background: rgba(76, 195, 255, 0.1); color: var(--accent); }
        .game-item.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- LAYOUT --- */
        .container {
            display: grid; grid-template-columns: 260px 680px 320px; gap: 24px;
            max-width: 1300px; margin: 24px auto; padding: 0 20px;
        }

        /* SIDEBAR LEFT */
        .sidebar-left { position: sticky; top: 140px; height: fit-content; }
        .menu-section { margin-bottom: 20px; }
        .menu-title { font-size: 12px; color: var(--text-sec); font-weight: bold; margin-bottom: 10px; padding-left: 10px; }
        .nav-item {
            display: flex; align-items: center; padding: 10px 14px; margin-bottom: 4px;
            border-radius: 8px; color: #666; text-decoration: none; transition: 0.2s; font-size: 15px;
        }
        .nav-item:hover { background-color: rgba(76, 195, 255, 0.1); color: var(--accent); }
        .nav-item.active { background-color: #e6f7ff; color: var(--accent); font-weight: 600; }
        .icon-box {
            width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; margin-right: 12px; background: #eee; color: #555; font-size: 14px;
        }
        .unity-icon { background: #000; color: #fff; }
        .rpg-icon { background: #e74c3c; color: #fff; }
        .scratch-icon { background: #f39c12; color: #fff; }

        /* CIRCLES */
        .circles-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .circle-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 15px;
            text-align: center; text-decoration: none; color: var(--text-main);
            border: 1px solid var(--border-color); transition: 0.2s;
        }
        .circle-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .circle-icon {
            width: 48px; height: 48px; border-radius: 12px; margin: 0 auto 8px;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;
        }
        .grad-tavern { background: linear-gradient(135deg, #FF6B6B, #FFD93D); }
        .grad-art { background: linear-gradient(135deg, #6C5CE7, #A29BFE); }
        .grad-lab { background: linear-gradient(135deg, #00B894, #55E6C1); }
        .grad-off { background: linear-gradient(135deg, #0984E3, #74B9FF); }

        /* FEED */
        .feed-header {
            background: var(--bg-card); padding: 0 20px; border-radius: var(--radius);
            margin-bottom: 16px; display: flex; border: 1px solid var(--border-color);
        }
        .tab-btn { padding: 15px 20px; cursor: pointer; font-weight: 600; color: var(--text-sec); border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        .post-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 24px;
            margin-bottom: 16px; border: 1px solid var(--border-color); transition: 0.2s;
        }
        .post-card.hidden { display: none; }
        .user-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar-ring { width: 46px; height: 46px; border-radius: 50%; padding: 2px; border: 2px solid var(--accent); margin-right: 12px; }
        .avatar-ring img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .post-title { font-size: 18px; margin-bottom: 8px; line-height: 1.4; font-weight: 700; }
        .post-text { color: #555; font-size: 14px; line-height: 1.6; margin-bottom: 12px; white-space: pre-wrap; }
        .topic-tag { display: inline-block; background: #f2f4f6; color: #666; padding: 4px 10px; border-radius: 15px; font-size: 12px; margin-bottom: 12px; text-decoration: none; font-weight: 600; }
        .image-grid { display: grid; gap: 8px; margin-bottom: 16px; border-radius: 8px; overflow: hidden; }
        .grid-1 { grid-template-columns: 1fr; max-height: 400px; }
        .image-grid img { width: 100%; height: 100%; object-fit: cover; }
        .post-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 12px; color: var(--text-sec); font-size: 13px; }
        .interactions { display: flex; gap: 24px; }
        .int-item { cursor: pointer; display: flex; align-items: center; gap: 6px; }

        /* SIDEBAR RIGHT */
        .sidebar-right { position: sticky; top: 140px; height: fit-content; }
        .profile-widget { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border-color); text-align: center; padding-bottom: 20px; margin-bottom: 16px; }
        .profile-bg { height: 80px; background: linear-gradient(90deg, #3498db, #2c3e50); }
        .profile-avatar { width: 70px; height: 70px; border-radius: 50%; border: 4px solid var(--bg-card); margin-top: -35px; background: #fff; object-fit: cover; }
        .creator-btn { background: var(--text-main); color: white; padding: 8px 20px; border-radius: 20px; text-decoration: none; font-size: 13px; margin-top: 10px; display: inline-block; cursor: pointer;}
        .trending-widget { background: var(--bg-card); border-radius: var(--radius); padding: 16px; border: 1px solid var(--border-color); margin-bottom: 16px; }
        .widget-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .trend-link { display: flex; justify-content: space-between; align-items: center; text-decoration: none; color: #555; font-size: 13px; margin-bottom: 10px; }
        .trend-link:hover { color: var(--accent); }
        .check-in-box { background: var(--bg-card); border-radius: var(--radius); padding: 15px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border-color); cursor: pointer; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-color); z-index: 3000; justify-content: center; align-items: center; }
        .modal-card { background: var(--bg-card); width: 600px; max-width: 90%; border-radius: 16px; padding: 25px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideUp 0.3s ease; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-close { cursor: pointer; font-size: 20px; color: #999; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-select, .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; }
        textarea.form-input { resize: vertical; min-height: 120px; }
        .media-preview-container { margin-top: 10px; position: relative; display: none; }
        .media-preview { width: 100%; max-height: 250px; border-radius: 8px; object-fit: cover; }
        .upload-label { cursor: pointer; color: var(--accent); display: inline-flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .modal-btn { padding: 8px 24px; border-radius: 20px; border: none; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #eee; color: #666; }
        .btn-submit { background: var(--accent); color: white; }
        .admin-check { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666; margin-right: auto; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @media (max-width: 1200px) { .container { grid-template-columns: 240px 1fr; } .sidebar-right { display: none; } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Devouring<span>Lab</span></div>
        <div class="search-bar"><i class="fas fa-search"></i><input type="text" placeholder="Buscar posts..."></div>
        
        <div class="nav-actions">
            <i class="fas fa-edit nav-icon-btn" id="openPublishBtn" title="Publicar"></i>
            <i class="fas fa-bell nav-icon-btn"></i>
            
            <div class="user-menu-wrapper">
                <img src="https://via.placeholder.com/32" class="user-avatar-nav" id="navAvatar">
                <div class="user-dropdown-card" id="userMenu">
                    <div id="loggedOutView">
                        <p style="font-size:14px; color:#666;">¡Únete a la comunidad!</p>
                        <button class="auth-btn btn-login" id="btnLoginGoogle"><i class="fab fa-google"></i> Acceder con Google</button>
                    </div>
                    <div id="loggedInView" style="display:none;">
                        <p style="font-weight:bold;" id="menuUserName">Usuario</p>
                        <p style="font-size:12px; color:#999; margin-bottom:10px;" id="menuUserEmail">email@ejemplo.com</p>
                        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                        <button class="auth-btn btn-register" id="btnLogout" style="border-color:#ff4c4c; color:#ff4c4c;">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="game-nav">
        <div class="game-item active" onclick="filterGame('all', this)"><i class="fas fa-globe"></i> General</div>
        <div class="game-item" onclick="filterGame('vireo', this)"><img src="https://via.placeholder.com/28"> Vireo CODE</div>
        <div class="game-item" onclick="filterGame('cae', this)"><img src="https://via.placeholder.com/28"> Cae</div>
        <div class="game-item" onclick="filterGame('lanzer', this)"><img src="https://via.placeholder.com/28"> Move-Lanzer</div>
        <div class="game-item" onclick="filterGame('dinoma', this)"><img src="https://via.placeholder.com/28"> Creatura Dinoma</div>
    </div>

    <div class="container">
        
        <aside class="sidebar-left">
            <div class="menu-section">
                <a href="#" class="nav-item active"><i class="fas fa-home" style="margin-right: 12px;"></i> Inicio</a>
                <a href="#" class="nav-item"><i class="fas fa-star" style="margin-right: 12px;"></i> Siguiendo</a>
            </div>
            <div class="menu-title">MIS INTERESES</div>
            <div class="menu-section">
                <a href="#" class="nav-item"><div class="icon-box unity-icon"><i class="fab fa-unity"></i></div> Unity Dev</a>
                <a href="#" class="nav-item"><div class="icon-box rpg-icon"><i class="fas fa-scroll"></i></div> RPG Maker</a>
            </div>
            <div class="menu-title">OTROS</div>
            <a href="https://lucasdanielsmm.github.io/DevouringProductions/" target="_blank" class="nav-item"><i class="fas fa-globe" style="margin-right: 12px;"></i> Web Oficial</a>
        </aside>

        <main id="mainFeed">
            <div class="circles-row">
                <a href="#" class="circle-card"><div class="circle-icon grad-tavern"><i class="fas fa-mug-hot"></i></div><div style="font-size:12px; font-weight:600">Taberna</div></a>
                <a href="#" class="circle-card"><div class="circle-icon grad-art"><i class="fas fa-paint-brush"></i></div><div style="font-size:12px; font-weight:600">Galería</div></a>
                <a href="#" class="circle-card"><div class="circle-icon grad-lab"><i class="fas fa-flask"></i></div><div style="font-size:12px; font-weight:600">Lab</div></a>
                <a href="#" class="circle-card"><div class="circle-icon grad-off"><i class="fas fa-shield-alt"></i></div><div style="font-size:12px; font-weight:600">Oficial</div></a>
            </div>

            <div class="feed-header">
                <div class="tab-btn active">Recientes</div>
                <div class="tab-btn">Siguiendo</div>
            </div>

            <div id="postsContainer"></div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-widget">
                <div class="profile-bg"></div>
                <img src="https://via.placeholder.com/70" class="profile-avatar" id="sidebarAvatar">
                <h3 style="font-size: 16px; margin-top: 5px;" id="sidebarName">Visitante</h3>
                <p style="font-size: 12px; color: #888; margin-bottom: 10px;">¡Únete a la diversión!</p>
                <div class="creator-btn" id="sidebarLoginBtn">Iniciar Sesión</div>
            </div>

            <div class="trending-widget">
                <div class="widget-title"><i class="fas fa-hashtag" style="color:var(--accent)"></i> Temas del momento</div>
                <a href="#" class="trend-link"><span># DevouringLab</span><span class="trend-label">Top</span></a>
            </div>
        </aside>
    </div>

    <div class="modal-overlay" id="publishModal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="font-size:18px;">Crear Publicación</h3>
                <i class="fas fa-times modal-close" id="closeModalBtn"></i>
            </div>
            
            <div class="form-row">
                <select id="postSection" class="form-select">
                    <option value="Taberna">Taberna</option>
                    <option value="Galería">Galería</option>
                    <option value="Lab">Lab</option>
                    <option value="Guías">Guías</option>
                </select>
                <select id="postGame" class="form-select">
                    <option value="all">General</option>
                    <option value="vireo">Vireo CODE</option>
                    <option value="cae">Cae</option>
                    <option value="lanzer">Move-Lanzer</option>
                    <option value="dinoma">Creatura Dinoma</option>
                </select>
            </div>

            <textarea id="postContent" class="form-input" placeholder="Comparte tus ideas, bugs o arte..."></textarea>
            <input type="text" id="postTags" class="form-input" placeholder="#Hashtags (ej: #Bug #FanArt)" style="margin-top:15px;">

            <div style="margin-top:15px;">
                <label for="fileInput" class="upload-label">
                    <i class="fas fa-image" style="font-size:20px;"></i> Agregar Imagen/Video
                </label>
                <input type="file" id="fileInput" style="display:none;" accept="image/*">
                <span id="uploadStatus" style="font-size:12px; color:#999; margin-left:10px;"></span>
                <div class="media-preview-container" id="previewContainer">
                    <img id="imagePreview" class="media-preview">
                </div>
            </div>

            <div class="modal-footer">
                <div class="admin-check" id="adminCheckContainer" style="display:none;">
                    <input type="checkbox" id="checkOfficial"> <label for="checkOfficial">Post Oficial</label>
                </div>
                <button class="modal-btn btn-cancel" id="cancelBtn">Cancelar</button>
                <button class="modal-btn btn-submit" id="submitPostBtn">Publicar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTAR LIBRERÍAS DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. PEGA TU FIREBASE CONFIG AQUÍ (PASO 1 DEL TUTORIAL)
        const firebaseConfig = {
            // !!!!!!! REEMPLAZA ESTO CON TUS DATOS REALES DE FIREBASE !!!!!!!
            apiKey: "AIzaSyC_vxI4azIIPRyXE3LCAlYDS1xKnwMSYmk",
            authDomain: "devouringlab.firebaseapp.com",
            projectId: "devouringlab",
            storageBucket: "devouringlab.firebasestorage.app",
            messagingSenderId: "383272939740",
            appId: "1:383272939740:web:203f83c89b1c7bd6344419"
        };

        // 3. INICIALIZAR APP
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // 4. CONFIGURACIÓN ADMIN Y CLOUDINARY
        const ADMIN_UIDS = [
            "PON_AQUI_TU_UID_DE_FIREBASE_AUTH" // Ejemplo: "kjsdhf734hkjdf87"
        ];
        const CLOUD_NAME = "dyhvx2vsz";
        const UPLOAD_PRESET = "DevouringIMG";

        // 5. VARIABLES DE ESTADO
        let currentUser = null;
        let currentGameContext = 'all';
        let uploadedImageUrl = "";

        // 6. REFERENCIAS DOM
        const modal = document.getElementById('publishModal');
        const openBtn = document.getElementById('openPublishBtn');
        const closeBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const submitBtn = document.getElementById('submitPostBtn');
        const fileInput = document.getElementById('fileInput');
        const btnLoginGoogle = document.getElementById('btnLoginGoogle');
        const btnLogout = document.getElementById('btnLogout');
        const sidebarLoginBtn = document.getElementById('sidebarLoginBtn');

        // --- AUTENTICACIÓN ---
        
        // Iniciar Sesión con Google
        const login = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error login:", error);
                alert("Error al iniciar sesión: " + error.message);
            }
        };

        btnLoginGoogle.addEventListener('click', login);
        sidebarLoginBtn.addEventListener('click', login);

        // Cerrar Sesión
        btnLogout.addEventListener('click', () => signOut(auth));

        // Listener de Estado (se ejecuta al loguearse/desloguearse)
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // UI Logueado
                document.getElementById('loggedOutView').style.display = 'none';
                document.getElementById('loggedInView').style.display = 'block';
                document.getElementById('navAvatar').src = user.photoURL;
                document.getElementById('menuUserName').innerText = user.displayName;
                document.getElementById('menuUserEmail').innerText = user.email;

                // Sidebar
                document.getElementById('sidebarAvatar').src = user.photoURL;
                document.getElementById('sidebarName').innerText = user.displayName;
                document.querySelector('.profile-widget p').innerText = "Miembro verificado";
                sidebarLoginBtn.style.display = 'none'; // Ocultar boton login sidebar
            } else {
                // UI Deslogueado
                document.getElementById('loggedOutView').style.display = 'block';
                document.getElementById('loggedInView').style.display = 'none';
                document.getElementById('navAvatar').src = "https://via.placeholder.com/32";
                
                // Sidebar
                document.getElementById('sidebarAvatar').src = "https://via.placeholder.com/70";
                document.getElementById('sidebarName').innerText = "Visitante";
                document.querySelector('.profile-widget p').innerText = "¡Únete a la diversión!";
                sidebarLoginBtn.style.display = 'inline-block';
            }
        });

        // --- LEER POSTS DE FIREBASE (TIEMPO REAL) ---
        const postsContainer = document.getElementById('postsContainer');
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            postsContainer.innerHTML = ""; // Limpiar antes de renderizar
            
            snapshot.forEach((doc) => {
                const post = doc.data();
                renderPost(post, doc.id);
            });
            // Reaplicar filtro actual
            window.filterGame(currentGameContext, document.querySelector(`.game-item[onclick*="${currentGameContext}"]`) || document.querySelector('.game-item'));
        });

        function renderPost(post, id) {
            const article = document.createElement('article');
            article.className = 'post-card';
            article.setAttribute('data-game', post.game);
            
            let gameName = "General";
            if(post.game === "vireo") gameName = "Vireo CODE";
            if(post.game === "cae") gameName = "Cae";
            if(post.game === "lanzer") gameName = "Move-Lanzer";
            if(post.game === "dinoma") gameName = "Creatura Dinoma";

            const officialBadge = post.isOfficial ? '<i class="fas fa-check-circle" style="color: #ffd700; margin-left:5px;" title="Oficial"></i>' : '';
            const borderStyle = post.isOfficial ? 'border: 2px solid #ffd700;' : '';
            const bgStyle = post.isOfficial ? 'background-color: #fffdf5;' : '';

            if(post.isOfficial) article.style.cssText = bgStyle;

            // Formato de fecha simple
            let timeString = "Reciente";
            if(post.timestamp) {
                const date = post.timestamp.toDate();
                timeString = date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            article.innerHTML = `
                <div class="user-header">
                    <div class="avatar-ring" style="${borderStyle}"><img src="${post.authorAvatar}"></div>
                    <div>
                        <h4 style="font-size: 14px;">${post.authorName} ${officialBadge}</h4>
                        <span style="font-size: 12px; color: #999;">${timeString} • <b>${gameName}</b> (${post.section})</span>
                    </div>
                </div>
                ${post.tags ? `<a href="#" class="topic-tag">${post.tags}</a>` : ''}
                <p class="post-text">${post.content}</p>
                ${post.image ? `<div class="image-grid grid-1"><img src="${post.image}"></div>` : ''}
                <div class="post-footer">
                    <div class="interactions">
                        <div class="int-item"><i class="far fa-heart"></i> Me gusta</div>
                    </div>
                </div>
            `;
            postsContainer.appendChild(article);
        }

        // --- FILTRO JUEGOS ---
        window.filterGame = (game, element) => {
            currentGameContext = game;
            document.querySelectorAll('.game-item').forEach(i => i.classList.remove('active'));
            if(element) element.classList.add('active');
            
            const posts = document.querySelectorAll('.post-card');
            posts.forEach(post => {
                if (game === 'all') post.classList.remove('hidden');
                else (post.getAttribute('data-game') === game) ? post.classList.remove('hidden') : post.classList.add('hidden');
            });
        }

        // --- SUBIDA IMAGEN CLOUDINARY ---
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
            }
            reader.readAsDataURL(file);

            // Upload
            const statusText = document.getElementById('uploadStatus');
            statusText.innerText = "Subiendo...";
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                uploadedImageUrl = data.secure_url;
                statusText.innerText = "¡Listo!";
                statusText.style.color = "green";
            } catch (err) {
                console.error(err);
                statusText.innerText = "Error subida.";
                statusText.style.color = "red";
            }
        });

        // --- PUBLICAR EN FIREBASE ---
        openBtn.addEventListener('click', () => {
            if (!currentUser) {
                alert("Debes iniciar sesión con Google para publicar.");
                return;
            }
            document.getElementById('postGame').value = currentGameContext;
            
            // Verificar si es admin para mostrar el checkbox
            if(ADMIN_UIDS.includes(currentUser.uid)) {
                document.getElementById('adminCheckContainer').style.display = 'flex';
            } else {
                document.getElementById('adminCheckContainer').style.display = 'none';
            }

            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        });

        submitBtn.addEventListener('click', async () => {
            const content = document.getElementById('postContent').value;
            const section = document.getElementById('postSection').value;
            const game = document.getElementById('postGame').value;
            const tags = document.getElementById('postTags').value;
            const isOfficialCheck = document.getElementById('checkOfficial').checked;

            if(!content && !uploadedImageUrl) {
                alert("El post está vacío.");
                return;
            }

            // Validar admin de nuevo al enviar (seguridad frontend)
            const isOfficial = isOfficialCheck && ADMIN_UIDS.includes(currentUser.uid);

            submitBtn.disabled = true;
            submitBtn.innerText = "Publicando...";

            try {
                await addDoc(collection(db, "posts"), {
                    authorName: currentUser.displayName,
                    authorAvatar: currentUser.photoURL,
                    authorUid: currentUser.uid,
                    content: content,
                    section: section,
                    game: game,
                    tags: tags,
                    image: uploadedImageUrl,
                    isOfficial: isOfficial,
                    timestamp: serverTimestamp()
                });
                closeModal();
            } catch (e) {
                console.error("Error al publicar: ", e);
                alert("Error al guardar en base de datos.");
            }
            submitBtn.disabled = false;
            submitBtn.innerText = "Publicar";
        });

        // --- CERRAR MODAL ---
        const closeModal = () => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            // Reset Form
            document.getElementById('postContent').value = "";
            document.getElementById('postTags').value = "";
            fileInput.value = "";
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('uploadStatus').innerText = "";
            uploadedImageUrl = "";
            document.getElementById('checkOfficial').checked = false;
        };
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        window.onclick = (e) => { if(e.target == modal) closeModal(); };

    </script>
</body>
</html>
